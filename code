import discord
import random
import os
from discord.ext import commands
from discord import app_commands

TOKEN = os.getenv("DISCORD_TOKEN")  
GUILD_ID = int(os.getenv("GUILD_ID"))  
WELCOME_CHANNEL_ID = int(os.getenv("WELCOME_CHANNEL_ID"))  

intents = discord.Intents.default()
intents.members = True  
bot = commands.Bot(command_prefix="!", intents=intents)

# Messages publics
welcome_messages = [
    """â˜ *Un lÃ©ger brouillard sâ€™Ã©lÃ¨ve, et lorsque la brume se dissipeâ€¦ une nouvelle Ã¢me se tient parmi nous.*  
âœ¨ Bienvenue, {user} ! Lumharel tâ€™accueille. Prenez un instant pour lui souhaiter la bienvenue !""",
    """ğŸ”¥ *Une flamme vacille dans lâ€™air avant de sâ€™Ã©lever doucementâ€¦ Une prÃ©sence nouvelle sâ€™ancre dans le monde.*  
ğŸŒŸ {user} vient dâ€™Ãªtre invoquÃ©Â·e en Lumharel ! Faites-lui un accueil chaleureux !""",
    """ğŸŒª *Le vent porte un murmure Ã  travers les terresâ€¦ Une voix nouvelle rÃ©sonne dans Lumharel.*  
ğŸŒ {user} a rejoint notre monde ! Laissez-lui un message pour guider ses premiers pas !""",
    """âœ¨ *Un Ã©clat de lumiÃ¨re traverse le cielâ€¦ Un fragment du destin vient de sâ€™incarner.*  
ğŸ”” {user}, bienvenue parmi nous ! Prenez un instant pour le saluer et lâ€™orienter !""",
    """ğŸ¦‰ *Un cri lointain retentit dans la nuit, annonÃ§ant un nouvel arrivant sous la protection des astres.*  
ğŸ“œ {user} rejoint Lumharel ! Que sa quÃªte commenceâ€¦ Souhaitez-lui un bon dÃ©part !"""
]

# Messages Ã©phemeral
ephemeral_messages = [
    "ğŸŒª *Le vent murmure ton arrivÃ©e...* {user}, ta place est Ã  dÃ©couvrir. Rejoins le canal #salons-et-rÃ´les !",
    "ğŸ”¥ *Une braise rougeoyante danse dans lâ€™airâ€¦* {user}, une nouvelle flamme sâ€™Ã©veille en Lumharel. Direction #salons-et-rÃ´les !",
    "âœ¨ *Un scintillement traverse lâ€™air...* {user}, lâ€™ombre et la lumiÃ¨re tâ€™accueillent. Trouve ta voie et rejoins le voyageâ€¦ #salons-et-rÃ´les !"
]

# Vue avec bouton
class WelcomeView(discord.ui.View):
    def __init__(self, member):
        super().__init__(timeout=None)
        self.member = member

    @discord.ui.button(label="ğŸ“œ DÃ©couvrir mon guide", style=discord.ButtonStyle.primary)
    async def send_ephemeral(self, interaction: discord.Interaction, button: discord.ui.Button):
        if interaction.user.id != self.member.id:
            await interaction.response.send_message("âš ï¸ Ce guide n'est pas pour toi !", ephemeral=True)
            return
        
        message = random.choice(ephemeral_messages).replace("{user}", interaction.user.mention)
        await interaction.response.send_message(message, ephemeral=True)

@bot.event
async def on_ready():
    print(f'âœ… {bot.user} est bien en ligne sur Discord !')

@bot.event
async def on_member_join(member):
    channel = bot.get_channel(WELCOME_CHANNEL_ID)
    if channel:
        welcome_text = random.choice(welcome_messages).replace("{user}", member.mention)
        await channel.send(welcome_text, view=WelcomeView(member))

bot.run(TOKEN)
