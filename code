import discord
import random
import os
from discord.ext import commands

TOKEN = os.getenv("DISCORD_TOKEN")
GUILD_ID = int(os.getenv("GUILD_ID"))
WELCOME_CHANNEL_ID = int(os.getenv("WELCOME_CHANNEL_ID"))

intents = discord.Intents.default()
intents.members = True
bot = commands.Bot(command_prefix="!", intents=intents)

# Messages de bienvenue alÃ©atoires (channel public)
welcome_messages = [
    """â˜ *Un lÃ©ger brouillard sâ€™Ã©lÃ¨ve, et lorsque la brume se dissipeâ€¦ une nouvelle Ã¢me se tient parmi nous.*  
âœ¨ Bienvenue, {user} ! Lumharel tâ€™accueille. Prenez un instant pour lui souhaiter la bienvenue !""",
    """ğŸ”¥ *Une flamme vacille dans lâ€™air avant de sâ€™Ã©lever doucementâ€¦ Une prÃ©sence nouvelle sâ€™ancre dans le monde.*  
ğŸŒŸ {user} vient dâ€™Ãªtre invoquÃ©Â·e en Lumharel ! Faites-lui un accueil chaleureux !""",
    """ğŸŒª *Le vent porte un murmure Ã  travers les terresâ€¦ Une voix nouvelle rÃ©sonne dans Lumharel.*  
ğŸŒ {user} a rejoint notre monde ! Laissez-lui un message pour guider ses premiers pas !""",
    """âœ¨ *Un Ã©clat de lumiÃ¨re traverse le cielâ€¦ Un fragment du destin vient de sâ€™incarner.*  
ğŸ”” {user}, bienvenue parmi nous ! Prenez un instant pour le saluer et lâ€™orienter !""",
    """ğŸ¦‰ *Un cri lointain retentit dans la nuit, annonÃ§ant un nouvel arrivant sous la protection des astres.*  
ğŸ“œ {user} rejoint Lumharel ! Que sa quÃªte commenceâ€¦ Souhaitez-lui un bon dÃ©part !"""
]

# Texte du guide immersif (ephemeral)
guide_message = """ğŸŒŸ **Bienvenue en Lumharel, voyageur !**

Ton pÃ©riple commence ici. Pour trouver ta place parmi nous, suis ces Ã©tapes :  

---

ğŸ“œ **1. DÃ©couvre nos terres**  
â†’ Consulte le salon <#1352146782095802378> pour en apprendre plus sur lâ€™univers de Lumharel.  
â†’ Les rumeurs et histoires du monde se trouvent dans <#1352130949403512872>.  

---

ğŸ­ **2. Choisis ton rÃ´le**  
â†’ Rendez-toi dans Salons et Roles pour choisir tes rÃ´les et dÃ©bloquer les accÃ¨s Ã  tout le serveur.  

---

ğŸ™ **3. Approche des Autels**  
â†’ Chaque jour, tu peux prier ou faire une offrande aux divinitÃ©s en te rendant Ã  leur autels: <#1353209819879837716>.  
â†’ Elles tâ€™accorderont des bÃ©nÃ©dictions et des **Lumes** (notre monnaie magique âœ¨).  

---

ğŸ¯ **4. Accomplis des quÃªtes**  
â†’ Consulte <#1352143818929078322> pour dÃ©couvrir les quÃªtes journaliÃ¨res et hebdomadaires.  
â†’ RÃ©compenses : **Lumes, bÃ©nÃ©dictions, et honneur** !  

---

ğŸ’¡ **5. Besoin dâ€™aide ?**  
â†’ Le salon <#1345479227310346335> est lÃ  pour toutes tes questions.  
â†’ Ou bien invoque le **Messager** dans les rumeurs pour obtenir des rÃ©ponses Ã©trangesâ€¦  

---

ğŸƒ *Ton histoire ne fait que commencer.  
Marche avec sagesse, et que les Souffles guident ton pas !*"""

# Classe bouton
class GuideButton(discord.ui.View):
    def __init__(self):
        super().__init__(timeout=None)

    @discord.ui.button(label="ğŸ“œ DÃ©couvrir mon guide", style=discord.ButtonStyle.primary, custom_id="welcome_guide")
    async def show_guide(self, interaction: discord.Interaction, button: discord.ui.Button):
        await interaction.response.send_message(guide_message, ephemeral=True)

@bot.event
async def on_ready():
    print(f'âœ… {bot.user} est bien en ligne !')

@bot.event
async def on_member_join(member):
    channel = bot.get_channel(WELCOME_CHANNEL_ID)
    if channel:
        welcome_text = random.choice(welcome_messages).replace("{user}", member.mention)
        await channel.send(welcome_text, view=GuideButton())  # bouton intÃ©grÃ©

bot.run(TOKEN)
